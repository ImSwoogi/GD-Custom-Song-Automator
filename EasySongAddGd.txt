import os
import random
import shutil
import tkinter as tk
from tkinter import filedialog, messagebox

def generate_random_id(song_directory):
    # Extract existing IDs from valid file names
    existing_ids = []
    for f in os.listdir(song_directory):
        if f.endswith('.mp3'):
            try:
                existing_ids.append(int(f.split('.')[0]))
            except ValueError:
                # Skip files that do not match the expected format
                continue

    # Generate a random unused ID
    while True:
        new_id = random.randint(100000, 999999)
        if new_id not in existing_ids:
            return new_id

def add_song():
    # Open file dialog to select MP3 file
    file_path = filedialog.askopenfilename(filetypes=[("MP3 Files", "*.mp3")])
    if not file_path:
        messagebox.showwarning("Warning", "No file selected. Please select an MP3 file.")
        return

    # Automatically detect the Geometry Dash directory under the AppData
    song_directory = os.path.join(os.getenv('APPDATA'), 'GeometryDash')
    if not os.path.exists(song_directory):
        # If GeometryDash is not found in APPDATA, try LOCALAPPDATA
        song_directory = os.path.join(os.getenv('LOCALAPPDATA'), 'GeometryDash')

    print(f"Song directory: {song_directory}")

    # Check if the directory exists and is writable
    if not os.path.exists(song_directory):
        messagebox.showerror("Error", f"{song_directory} directory not found.")
        return
    if not os.access(song_directory, os.W_OK):
        messagebox.showerror("Error", f"Cannot write to {song_directory}.")
        return

    try:
        print(f"Selected file: {file_path}")
        
        # Extract existing IDs from valid file names
        existing_ids = []
        for f in os.listdir(song_directory):
            if f.endswith('.mp3'):
                try:
                    existing_ids.append(int(f.split('.')[0]))
                except ValueError:
                    continue

        # Generate a random unused song ID
        new_id = generate_random_id(song_directory)
        print(f"Generated ID: {new_id}")

        # Construct the new file name and path
        new_file_name = f"{new_id}.mp3"
        new_file_path = os.path.join(song_directory, new_file_name)
        print(f"New file path: {new_file_path}")

        # Ensure the file is being copied
        shutil.copy(file_path, new_file_path)
        print(f"File copied successfully to: {new_file_path}")

        messagebox.showinfo("Success", f"Song added successfully!\nSong ID: {new_id}\nFile Name: {new_file_name}")
    except Exception as e:
        messagebox.showerror("Error", f"An error occurred: {e}")
        print(f"Error: {e}")

# Create the main window
root = tk.Tk()
root.title("Geometry Dash Custom Song Adder")

# Create a button to add songs
add_song_button = tk.Button(root, text="Add Song", command=add_song, font=("Arial", 14), padx=20, pady=10)
add_song_button.pack(pady=20)

# Run the application
root.mainloop()
